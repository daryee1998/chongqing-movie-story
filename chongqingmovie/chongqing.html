<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>å±±åŸ - æ‰‹æœ­</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'FuLuLuxi';
            src: url('assets/fonts/fulu-luxi-2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'A131';
            src: url('assets/fonts/A131-å§¥å§¥è¯´åª’å°è‰¾ç¹ä½“.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'HuiwenMingchao';
            src: url('assets/fonts/huiwenmingchaoti.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Superwild';
            src: url('assets/fonts/superwild-nax0j.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Lenyah';
            src: url('assets/fonts/lenyah-v4qye.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --text-color: #e0c0c0;
            --red-glow: rgba(255, 0, 0, 0.4);
            --red-border: rgba(180, 0, 0, 0.7);
            --dark-red-bg: rgba(60, 10, 10, 0.8);
            /* Light theme colors */
            --light-bg: rgba(245, 240, 220, 0.85); /* Creamy */
            --light-text: #443;
            --light-border: rgba(180, 150, 90, 0.7);
            --light-glow: rgba(255, 200, 100, 0.4);
            --light-accent-bg: rgba(210, 180, 120, 0.8);
            /* Deep blue semi-transparent background for inputs */
            --deep-blue-bg: rgba(10, 20, 50, 0.7);
            --deep-blue-border: rgba(30, 50, 100, 0.8);
            --deep-blue-glow: rgba(50, 80, 150, 0.5);

            --notebook-width: 95vw;
            --notebook-height: 90vh;
            --chinese-font: 'FuLuLuxi', serif;
            --english-font: 'Superwild', serif;
            --quote-font: 'HuiwenMingchao', serif;
            --button-font: 'Lenyah', serif;
        }

        .video-background {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)),
                url('https://i.guancha.cn/bbs/2021/01/25/20210125145949466.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #000;
            animation: backgroundPulse 8s ease-in-out infinite;
            filter: saturate(1.3) contrast(1.1) brightness(1.2);
        }

        .video-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 0, 111, 0.2), 
                rgba(0, 255, 200, 0.2));
            mix-blend-mode: color;
            pointer-events: none;
        }

        .video-background::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            animation: scanlines 0.5s linear infinite;
        }

        @keyframes backgroundPulse {
            0% { filter: saturate(1.3) contrast(1.1) brightness(1.2) hue-rotate(0deg); }
            50% { filter: saturate(1.4) contrast(1.2) brightness(1.3) hue-rotate(10deg); }
            100% { filter: saturate(1.3) contrast(1.1) brightness(1.2) hue-rotate(0deg); }
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(2px); }
        }

        body {
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            background: transparent;
            color: var(--text-color);
            font-family: var(--chinese-font);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background-color 0.5s ease-in-out;
        }

        /* Add 3D tilt effect to notebook */
        .notebook {
            width: var(--notebook-width);
            max-width: 100%;
            height: var(--notebook-height);
            max-height: 100%;
            background-color: rgba(10, 12, 18, 0.6);
            border: 1px solid rgba(0, 255, 200, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 200, 0.2),
                       0 0 40px rgba(255, 0, 111, 0.15),
                       inset 0 0 30px rgba(0, 255, 200, 0.1);
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: box-shadow 0.5s ease;
        }

        .notebook:hover {
            box-shadow: 0 0 30px rgba(0, 255, 200, 0.3),
                       0 0 60px rgba(255, 0, 111, 0.25),
                       inset 0 0 40px rgba(0, 255, 200, 0.15);
        }

        /* Remove the problematic animation */
        .notebook::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(0, 255, 200, 0.08),
                rgba(255, 0, 111, 0.08));
            pointer-events: none;
        }

        /* Remove the hologramSheen animation */
        @keyframes hologramSheen {
            0% { transform: translateX(-100%) translateY(-100%); }
            50% { transform: translateX(100%) translateY(100%); }
            100% { transform: translateX(-100%) translateY(-100%); }
        }

        .notebook-inner {
             position: relative;
             width: 100%;
             height: 100%;
            transition: none;
        }

        .notebook.flipped .notebook-inner {
            transform: none;
        }

        .notebook-page {
            position: absolute;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: none;
            pointer-events: auto;
        }

        .notebook-front {
            background: linear-gradient(135deg,
                rgba(10, 12, 18, 0.6) 0%,
                rgba(20, 24, 36, 0.6) 100%);
            border: 1px solid rgba(0, 255, 200, 0.2);
            z-index: 1;
            display: flex;
            flex-direction: column;
        }

        .notebook.flipped .notebook-front {
            display: none;
        }

        .notebook-back {
            background: linear-gradient(135deg,
                rgba(10, 12, 18, 0.6) 0%,
                rgba(20, 24, 36, 0.6) 100%);
            border: 1px solid rgba(255, 0, 111, 0.2);
            z-index: 2;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            font-size: 1.2em;
            color: #aaa;
            padding-top: 40px;
        }

        .notebook.flipped .notebook-back {
            display: flex;
        }

        .next-page-arrow {
            position: fixed;
            right: 0;
            top: 0;
            width: 50px;
            height: 100vh;
            background: linear-gradient(to right, transparent, rgba(240, 208, 208, 0.05));
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            border: none;
            outline: none;
        }

        .next-page-arrow.enabled {
            opacity: 0.5;
            pointer-events: auto;
        }

        .next-page-arrow:hover {
            background: linear-gradient(to right, transparent, rgba(240, 208, 208, 0.15));
            width: 60px;
        }

        .next-page-arrow::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-top: 1px solid rgba(240, 208, 208, 0.3);
            border-right: 1px solid rgba(240, 208, 208, 0.3);
            transform: translateY(-50%) rotate(45deg);
            transition: all 0.3s ease;
        }

        .next-page-arrow:hover::after {
            right: 15px;
            border-color: rgba(240, 208, 208, 0.5);
        }

        .controls-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
            border-radius: 4px;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* Add hover effect to input fields */
        input[type="text"],
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 18px;
            background: rgba(10, 20, 30, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.95);
            border-radius: 3px;
            font-size: 1.1em;
            font-family: var(--quote-font) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2),
                       inset 0 0 5px rgba(0, 0, 0, 0.1);
            outline: none;
            flex-grow: 1;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transform: translateY(0);
            position: relative;
            overflow: hidden;
        }

        input[type="text"]::before,
        select::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transition: 0.5s;
        }

        input[type="text"]:hover::before,
        select:hover::before {
            left: 100%;
        }

        input[type="text"]:hover,
        select:hover {
            background: rgba(20, 30, 40, 0.35);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.25),
                       inset 0 0 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        input[type="text"]:active,
        select:active {
            transform: translateY(1px);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3),
                       inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        input[type="text"]:focus,
        select:focus {
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3),
                       inset 0 0 8px rgba(0, 0, 0, 0.15);
            background: rgba(10, 20, 30, 0.35);
            transform: translateY(-1px);
        }

        select {
            flex-grow: 0;
            min-width: 180px;
            appearance: none;
            background: rgba(10, 20, 30, 0.4) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23f0d0d0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>') no-repeat right 12px center;
            background-size: 14px;
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.7);
            opacity: 0.8;
            font-family: var(--quote-font) !important;
        }

        select option[disabled] {
            color: rgba(255, 255, 255, 0.7);
            font-family: var(--quote-font) !important;
        }

        select option {
             background: #300505;
             color: rgba(255, 255, 255, 1);
             font-family: var(--quote-font) !important;
        }

        .revealed-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            padding: 0;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            height: auto;
            overflow: visible;
        }

        .images-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-bottom: 15px;
            background: transparent;
        }

        .movie-poster, .building-img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            border: none;
            border-radius: 0;
            box-shadow: none;
            background-color: transparent;
            transition: transform 0.5s ease, box-shadow 0.5s ease;
        }

        .movie-poster:hover, .building-img:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(0, 255, 200, 0.4);
        }

        /* Remove media queries for horizontal layout */
        @media (min-width: 768px) {
            .movie-poster, .building-img {
                max-height: 500px;
            }
        }

        /* Remove special handling for vertical layout since all layouts are now vertical */
        .images-container.vertical {
            flex-direction: column;
            gap: 15px;
        }

        .images-container.vertical .movie-poster,
        .images-container.vertical .building-img {
            width: 100%;
            height: auto;
            max-height: 400px;
            margin-bottom: 0;
        }

        .quote {
            font-style: normal;
            color: rgba(255, 255, 255, 1);
            font-size: 1.5em;
            line-height: 1.8;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.8),
                         0 0 10px rgba(0, 255, 255, 0.5),
                         0 0 15px rgba(255, 0, 111, 0.5),
                         0 0 20px rgba(255, 0, 111, 0.3),
                         0 0 25px rgba(255, 255, 255, 0.1);
            margin: 0 0 30px 0;
            padding: 25px;
            background: rgba(10, 12, 18, 0.4);
            border: 1px solid rgba(0, 255, 200, 0.3);
            border-radius: 8px;
            text-align: center;
            position: relative;
            font-family: var(--quote-font);
            letter-spacing: 3px;
            order: -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            gap: 0.8em;
            font-weight: 300;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 0 20px rgba(0, 255, 200, 0.2),
                        inset 0 0 15px rgba(255, 0, 111, 0.15);
            animation: quoteGlow 3s ease-in-out infinite alternate;
            animation: float 6s ease-in-out infinite;
            overflow: hidden; /* æ·»åŠ æº¢å‡ºéšè—ï¼Œé˜²æ­¢ç²’å­æ•ˆæœæº¢å‡º */
        }

        /* æ·»åŠ ç²’å­æ¹®ç­æ•ˆæœ */
        .quote .chinese, .quote .english {
            position: relative;
        }

        .quote .chinese::before, .quote .english::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, 
                rgba(0, 255, 255, 0.2) 0%, 
                rgba(255, 0, 111, 0.1) 30%, 
                transparent 70%);
            opacity: 0;
            pointer-events: none;
            animation: particleGlow 4s ease-in-out infinite;
        }

        @keyframes particleGlow {
            0%, 100% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* æ·»åŠ æ–‡å­—ç²’å­æ•ˆæœ */
        .quote .chinese span, .quote .english span {
            position: relative;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .quote .chinese span:hover, .quote .english span:hover {
            transform: translateY(-2px);
            text-shadow: 0 0 8px rgba(0, 255, 255, 1),
                         0 0 15px rgba(0, 255, 255, 0.8),
                         0 0 20px rgba(255, 0, 111, 0.8),
                         0 0 25px rgba(255, 0, 111, 0.6),
                         0 0 30px rgba(255, 255, 255, 0.4);
        }

        /* æ·»åŠ ç²’å­å®¹å™¨ */
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .text-particle {
            position: absolute;
            background: radial-gradient(circle, 
                rgba(0, 255, 255, 0.8) 0%, 
                rgba(255, 0, 111, 0.6) 50%, 
                transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            animation: particleFade 1.5s ease-out forwards;
        }

        @keyframes particleFade {
            0% { 
                transform: scale(0.5) translateY(0); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1.5) translateY(-20px); 
                opacity: 0; 
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }

        .quote .chinese {
            display: block;
            text-align: center;
            width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-weight: 300;
            letter-spacing: 5px;
            color: rgba(255, 255, 255, 1);
            font-family: var(--quote-font);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.8),
                         0 0 10px rgba(0, 255, 255, 0.5),
                         0 0 15px rgba(255, 0, 255, 0.3),
                         0 0 20px rgba(255, 0, 255, 0.2);
            animation: textGlow 2s ease-in-out infinite alternate;
            transition: transform 0.3s ease;
        }

        .quote .chinese:hover {
            transform: translateY(-2px);
        }

        .quote .english {
            font-family: var(--english-font) !important;
            font-size: 1em;
            display: block;
            color: rgba(255, 255, 255, 0.95);
            text-align: center;
            width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.6),
                         0 0 10px rgba(0, 255, 255, 0.4);
            opacity: 0.9;
            transition: transform 0.3s ease, opacity 0.3s ease;
            margin-top: 0.8em;
        }

        .quote .english:hover {
            opacity: 1;
            transform: translateY(-1px);
        }

        .quote::before,
        .quote::after {
            content: '"';
            font-size: 2.4em;
            position: absolute;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.8),
                         0 0 10px rgba(0, 255, 255, 0.5);
            animation: quoteMarkGlow 2s ease-in-out infinite alternate;
        }

        .quote::before {
            left: 15px;
            top: 5px;
        }

        .quote::after {
            right: 15px;
            bottom: 5px;
        }

        @keyframes textGlow {
            from {
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.8),
                            0 0 10px rgba(0, 255, 255, 0.5),
                            0 0 15px rgba(255, 0, 255, 0.3),
                            0 0 20px rgba(255, 0, 255, 0.2);
            }
            to {
                text-shadow: 0 0 7px rgba(0, 255, 255, 0.9),
                            0 0 12px rgba(0, 255, 255, 0.6),
                            0 0 17px rgba(255, 0, 255, 0.4),
                            0 0 22px rgba(255, 0, 255, 0.3);
            }
        }

        @keyframes quoteGlow {
            from {
                box-shadow: 0 0 20px rgba(0, 255, 200, 0.2),
                           inset 0 0 15px rgba(255, 0, 111, 0.15);
            }
            to {
                box-shadow: 0 0 25px rgba(0, 255, 200, 0.3),
                           inset 0 0 20px rgba(255, 0, 111, 0.25);
            }
        }

        @keyframes quoteMarkGlow {
            from {
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.8),
                            0 0 10px rgba(0, 255, 255, 0.5);
            }
            to {
                text-shadow: 0 0 7px rgba(0, 255, 255, 0.9),
                            0 0 12px rgba(0, 255, 255, 0.6);
            }
        }

        /* Add ripple effect to buttons */
        #generateStoryBtn {
            background: linear-gradient(45deg,
                rgba(0, 20, 40, 0.9),
                rgba(0, 40, 80, 0.9));
            border: 1px solid rgba(0, 255, 200, 0.3);
            color: rgba(0, 255, 200, 0.9);
            box-shadow: 0 0 10px rgba(0, 255, 200, 0.2);
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.5);
            font-size: 1.3em;
            font-family: 'Lenyah' !important;
            cursor: pointer;
            border-radius: 3px;
            padding: 10px 20px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }

        #generateStoryBtn:hover {
            background: linear-gradient(45deg,
                rgba(0, 30, 60, 0.9),
                rgba(0, 50, 100, 0.9));
            box-shadow: 0 0 20px rgba(0, 255, 200, 0.3);
            text-shadow: 0 0 8px rgba(0, 255, 200, 0.7);
            transform: translateY(-1px);
        }

        #generateStoryBtn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }

        /* Remove ripple effect styles */
        .ripple {
            display: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        #story-output {
            width: 100%;
            height: auto;
            box-sizing: border-box;
            background: rgba(20, 20, 30, 0.3);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 8px;
            padding: 30px;
            text-align: left;
            font-size: 1.1em;
            line-height: 2;
            color: rgba(255, 255, 255, 1);
            font-family: var(--quote-font);
            letter-spacing: 0.8px;
            box-shadow: 0 0 20px rgba(50, 50, 150, 0.4), inset 0 0 15px rgba(100, 100, 255, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none; /* Hide by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        #story-output.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #story-output p:first-child {
            text-align: center;
            color: rgba(255, 255, 255, 1);
            font-size: 1.8em;
            margin-bottom: 40px;
            font-family: var(--quote-font);
            font-weight: 300;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(100, 100, 255, 0.5);
            position: relative;
            padding-bottom: 15px;
        }

        #story-output p:not(:first-child):not(.english) {
            font-family: var(--quote-font);
            margin-bottom: 2em;
            font-weight: 300;
            letter-spacing: 0.8px;
            text-indent: 2em;
            line-height: 2.2;
            position: relative;
            padding-left: 15px;
            border-left: 2px solid rgba(100, 100, 255, 0.3);
            color: rgba(255, 255, 255, 1);
        }

        #story-output p.english {
            font-family: var(--english-font) !important;
            font-size: 0.95em;
            margin-top: 25px;
            color: rgba(255, 255, 255, 1);
            font-style: italic;
            letter-spacing: 0.6px;
            line-height: 1.9;
            padding-left: 1.5em;
            border-left: 2px solid rgba(100, 100, 255, 0.2);
            background: rgba(30, 30, 50, 0.3);
            padding: 15px 20px;
            border-radius: 4px;
            text-align: center;
        }

        /* Add specific style for English title */
        #story-output p.english strong {
            display: block;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            letter-spacing: 1px;
            width: 100%;
        }

        /* Ensure the first English paragraph (title) is centered */
        #story-output p.english:first-of-type {
            text-align: center;
            padding: 0;
            border-left: none;
            background: none;
        }

        .story-genre {
            margin-bottom: 15px;
            font-size: 0.95em;
            font-style: italic;
            height: 1.2em;
            font-family: var(--quote-font);
            color: rgba(255, 255, 255, 1);
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #aaa;
            font-style: italic;
            font-family: 'Lenyah' !important;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            letter-spacing: 1px;
        }

        .loading-text {
            font-family: 'Lenyah' !important;
            font-size: 1.3em;
            letter-spacing: 1.5px;
        }

        .loading-percentage {
            font-family: 'Lenyah' !important;
            font-size: 1.5em;
            margin-top: 10px;
            color: rgba(245, 240, 220, 0.8);
            font-weight: bold;
            transition: color 0.3s;
            letter-spacing: 1px;
        }

        .loading-bar {
            width: 200px;
            height: 4px;
            background-color: rgba(0, 255, 200, 0.1);
            border-radius: 2px;
            margin-top: 25px;
            overflow: visible;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 200, 0.3),
                       0 0 20px rgba(255, 0, 111, 0.2);
        }

        .loading-bar-fill {
            height: 100%;
            background: linear-gradient(90deg,
                rgba(0, 255, 200, 0.8),
                rgba(255, 0, 111, 0.8));
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 2px;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 200, 0.4),
                       0 0 20px rgba(255, 0, 111, 0.3);
        }

        .camera-icon {
            position: absolute;
            right: -25px;
            top: -20px;
            width: 40px;
            height: 40px;
            animation: pulse 1s ease-in-out infinite alternate, sway 3s ease-in-out infinite;
            transform-origin: center bottom;
        }

        .camera-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 2px rgba(0, 255, 200, 0.3));
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }

        @keyframes sway {
            0% {
                transform: rotate(-5deg);
            }
            50% {
                transform: rotate(5deg);
            }
            100% {
                transform: rotate(-5deg);
            }
        }

        /* Back Arrow Button */
        .back-page-arrow {
            position: fixed;
            left: 0;
            top: 0;
            width: 50px;
            height: 100vh;
            background: linear-gradient(to left, transparent, rgba(240, 208, 208, 0.05));
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            border: none;
            outline: none;
        }

        .back-page-arrow.enabled {
            opacity: 0.5;
            pointer-events: auto;
        }

        .back-page-arrow:hover {
            background: linear-gradient(to left, transparent, rgba(240, 208, 208, 0.15));
            width: 60px;
        }

        /* Next Arrow Button */
        .next-page-arrow {
            position: fixed;
            right: 0;
            top: 0;
            width: 50px;
            height: 100vh;
            background: linear-gradient(to right, transparent, rgba(240, 208, 208, 0.05));
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            border: none;
            outline: none;
        }

        .next-page-arrow.enabled {
            opacity: 0.5;
            pointer-events: auto;
        }

        .next-page-arrow:hover {
            background: linear-gradient(to right, transparent, rgba(240, 208, 208, 0.15));
            width: 60px;
        }

        /* æ·»åŠ åª’ä½“æŸ¥è¯¢ï¼Œé’ˆå¯¹æ‰‹æœºç«–å±ä¼˜åŒ– */
        @media (max-width: 768px) {
            :root {
                --notebook-width: 95vw;
                --notebook-height: 90vh;
            }

            body {
                padding: 5px;
            }

            .notebook-page {
                padding: 15px;
            }

            input[type="text"],
            select,
            #generateStoryBtn {
                font-size: 1.2em;
                padding: 15px 20px;
            }

            .quote {
                font-size: 1.1em;
                padding: 15px;
            }
            
            .movie-poster, .building-img {
                max-height: 250px;
            }
            
            #story-output {
                padding: 15px;
                font-size: 1em;
            }
            
            #story-output p:first-child {
                font-size: 1.5em;
                margin-bottom: 30px;
            }
            
            .next-page-arrow, .back-page-arrow {
                width: 60px;
            }
            
            .next-page-arrow.enabled, .back-page-arrow.enabled {
                opacity: 0.7;
            }
        }
        
        /* æ·»åŠ è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) {
            .next-page-arrow, .back-page-arrow {
                opacity: 0.7;
            }
            
            .next-page-arrow.enabled, .back-page-arrow.enabled {
                opacity: 1;
            }
            
            .movie-poster:hover, .building-img:hover {
                transform: none;
                box-shadow: none;
            }
            
            .quote .chinese:hover, .quote .english:hover {
                transform: none;
            }
            
            #generateStoryBtn:hover {
                transform: none;
            }
            
            input[type="text"]:hover, select:hover {
                transform: none;
            }
        }

        /* --- Style-based themes --- */
        .style-light {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .style-dark {
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
        }

        @media (min-width: 1024px) {
            :root {
                --notebook-width: 800px;
                --notebook-height: 800px;
            }

            body {
                padding: 40px;
            }

            .notebook-page {
                padding: 30px;
            }

            input[type="text"],
            select,
            #generateStoryBtn {
                font-size: 1.2em;
                padding: 15px 20px;
            }

            .quote {
                font-size: 1.1em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .notebook-page {
                padding: 15px;
            }

            input[type="text"],
            select,
            #generateStoryBtn {
                font-size: 1em;
                padding: 10px 15px;
            }

            .quote {
                font-size: 0.9em;
            }
        }

        /* Global font settings - default to Chinese font */
        * {
            font-family: var(--chinese-font);
        }

        /* Quote specific font settings */
        .quote,
        .quote .chinese,
        .story-genre {
            font-family: var(--quote-font) !important;
        }

        /* Second page story content - use HuiwenMingchao font */
        #story-output {
            font-family: var(--quote-font) !important;
        }

        #story-output p:first-child {
            font-family: var(--quote-font) !important;
        }

        #story-output p:not(:first-child):not(.english) {
            font-family: var(--quote-font) !important;
        }

        #story-output p.english {
            font-family: var(--english-font) !important;
        }

        /* Remove conflicting rules */
        /* Ensure all Chinese text uses FuLuLuxi */
        body, 
        p, 
        h1, h2, h3, h4, h5, h6, 
        span:not(.english):not(.chinese), 
        div:not(.english):not(#story-output):not(.quote):not(.story-genre), 
        button:not(#generateStoryBtn), 
        .notebook-back,
        .notebook-front,
        .controls-area,
        .input-group,
        .revealed-content,
        .images-container,
        .movie-poster,
        .building-img,
        .next-page-arrow,
        .back-page-arrow {
            font-family: var(--chinese-font) !important;
        }

        /* Override select styles */
        select {
            font-family: var(--quote-font) !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: rgba(10, 20, 30, 0.8) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23f0d0d0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>') no-repeat right 12px center !important;
            background-size: 14px !important;
            padding-right: 30px !important;
        }

        select option {
            font-family: var(--quote-font) !important;
            background-color: #300505;
            color: rgba(255, 255, 255, 1);
        }

        select:focus {
            border-color: rgba(0, 255, 200, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.3),
                       inset 0 0 8px rgba(0, 255, 200, 0.2);
        }

        /* Override any conflicting font rules */
        #generateStoryBtn,
        .loading,
        .loading-text,
        .loading-percentage {
            font-family: 'Lenyah' !important;
        }

        /* Add a more specific override at the end of the CSS */
        .notebook-back .loading,
        .notebook-back .loading-text,
        .notebook-back .loading-percentage {
            font-family: 'Lenyah' !important;
        }

        /* Override any other potential font settings */
        #generateStoryBtn,
        .loading *,
        .loading-text,
        .loading-percentage {
            font-family: 'Lenyah' !important;
        }

        /* Ensure loading elements in story output use Lenyah */
        #story-output div[class^="loading"] {
            font-family: 'Lenyah' !important;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .notebook-page::-webkit-scrollbar {
            width: 4px;
            background: transparent;
        }

        .notebook-page::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            transition: background 0.3s ease;
        }

        .notebook-page::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .notebook-page::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
        .notebook-page {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.08) transparent;
        }

    </style>
</head>

<body>
    <div class="video-background"></div>
    <!-- å¦‚æœèƒŒæ™¯å›¾ç‰‡æ— æ³•åŠ è½½ï¼Œæ˜¾ç¤ºé™æ€å›¾ç‰‡ä½œä¸ºåå¤‡ -->
    <img src="https://i.guancha.cn/bbs/2021/01/25/20210125145949466.jpeg" alt="Background Image" style="display: none;">
    <div class="notebook" id="notebook">
        <div class="notebook-inner">
            <div class="notebook-page notebook-front">

                <div class="controls-area">
                <div class="input-group">
                         <input type="text" id="name" placeholder="your name">
                    <select id="location">
                             <option value="" disabled selected>select a place</option>
                        <option value="é•¿æ±Ÿç´¢é“">é•¿æ±Ÿç´¢é“</option>
                        <option value="æ¥ç¦å£«">æ¥ç¦å£«</option>
                        <option value="é˜²ç©ºæ´ç«é”…">é˜²ç©ºæ´ç«é”…</option>
                        <option value="äº¤é€šèŒ¶é¦†">äº¤é€šèŒ¶é¦†</option>
                        <option value="æå­å">æå­å</option>
                        <option value="çš‡å† å¤§æ‰¶æ¢¯">çš‡å† å¤§æ‰¶æ¢¯</option>
                        <option value="æ´ªå´–æ´">æ´ªå´–æ´</option>
                        <option value="ç£å™¨å£">ç£å™¨å£</option>
                    </select>
                    </div>
                    <!-- Removed Reveal Button -->
                    <!-- <button id="revealBtn" onclick="handleRevealClick()" title="æ­ç¤ºå†…å®¹">ğŸš‡</button> -->
                </div>

                <div class="revealed-content" id="content">
                    <p id="quote" class="quote"></p>
                    <div class="images-container">
                    <img id="poster" class="movie-poster" src="" alt="Movie Poster">
                         <img id="building" class="building-img" src="" alt="Building Image">
                    </div>
                </div>

                 <button class="next-page-arrow" id="nextPageArrow" onclick="slidePage()"></button>

            </div>

            <div class="notebook-page notebook-back" id="notebookBack">
                 <!-- Back Arrow -->
                 <button class="back-page-arrow" onclick="slideBack()" title="è¿”å›ä¸Šä¸€é¡µ"></button>

                 <!-- Genre Display -->
                 <div class="story-genre" id="storyGenre"></div>
                 <!-- Generate Button -->
                 <button id="generateStoryBtn">generate a film story..</button>
                 <!-- Story Output -->
                 <div id="story-output"></div>
                 <!-- Save as Image Button -->
                 <button id="saveAsImageBtn" onclick="saveStoryAsImage()" style="display: none;">Save as Image</button>
            </div>
        </div>
    </div>

    <script>
        const locations = [
            { name: 'åƒå®é—¨å¤§æ¡¥', image: 'assets/images/åƒå®é—¨å¤§æ¡¥.png' },
            { name: 'æå­å', image: 'assets/images/æå­å.jpg' },
            { name: 'ç™½è±¡å±…', image: 'assets/images/ç™½è±¡å±….png' },
            { name: 'é•¿æ±Ÿç´¢é“', image: 'assets/images/é•¿æ±Ÿç´¢é“1.png' },
            { name: 'çš‡å† å¤§æ‰¶æ¢¯', image: 'assets/images/çš‡å† å¤§æ‰¶æ¢¯1.png' },
            { name: 'æœå¤©é—¨ç å¤´', image: 'assets/images/æœå¤©é—¨ç å¤´1.png' },
            { name: 'å¼¹å­çŸ³ç å¤´', image: 'assets/images/å¼¹å­çŸ³ç å¤´.jpg' },
            { name: 'æ¥ç¦å£«', image: 'assets/images/æ¥ç¦å£«.jpg' },
            { name: 'å—æ»¨è·¯', image: 'assets/images/å—æ»¨è·¯2.jpg' },
            { name: 'è€å±…æ°‘æ¥¼', image: 'assets/images/è€å±…æ°‘æ¥¼.png' }
        ];

        const movies = [
            { name: 'ç–¯ç‹‚çš„çŸ³å¤´', image: 'assets/images/ç–¯ç‹‚çš„çŸ³å¤´1.png' },
            { name: 'å°‘å¹´çš„ä½ ', image: ['assets/images/å°‘å¹´çš„ä½ 1.jpg', 'assets/images/å°‘å¹´çš„ä½ 2.jpg'] },
            { name: 'æ—¥ç…§é‡åº†', image: 'assets/images/æ—¥ç…§é‡åº†1.jpg' },
            { name: 'åˆºæ€å°è¯´å®¶', image: 'assets/images/åˆºæ€å°è¯´å®¶.jpg' },
            { name: 'é“¤è€Œèµ°é™©', image: 'assets/images/é“¤è€Œèµ°é™©.jpg' },
            { name: 'å¥½å¥‡å®³æ­»çŒ«', image: 'assets/images/å¥½å¥‡å®³æ­»çŒ«.jpg' },
            { name: 'å—ç›Šäºº', image: 'assets/images/å—ç›Šäºº.jpg' },
            { name: 'ç§˜å²¸', image: 'assets/images/ç§˜å²¸.jpg' },
            { name: 'åšå¦‚ç£çŸ³', image: 'assets/images/åšå¦‚ç£çŸ³.jpg' }
        ];

        // å°è¯åº“
        const quotes = {
            'åƒå®é—¨å¤§æ¡¥': [
                "ä½ æ˜¯ä¸€åªèƒ½è¿‡æ²³çš„å’ï¼Œåªèƒ½è¿›ä¸èƒ½é€€ã€‚\nYou are a pawn that can cross the river, you can only move forward, not backward.",
                "ä¸€æ¡ç‹—ï¼Œåƒè¿‡ä¸€å£è‚‰ï¼Œå°±å†ä¹Ÿä¸æƒ³åƒéª¨å¤´ã€‚\nOnce a dog has tasted meat, it no longer wants bones."
            ],
            'æå­å': [
                "è¿™åŸå¸‚åƒä¸ªè¿·å®«ï¼Œèµ°é”™ä¸€æ­¥å°±å‡ºä¸å»äº†ã€‚\nThis city is like a maze, one wrong step and you can't get out.",
                "åœ¨é»‘æš—é‡Œæ‰¾è·¯çš„äººï¼Œä¸æ˜¯è¢«å½±å­åæ²¡ï¼Œå°±æ˜¯æŠŠè‡ªå·±å˜æˆç¯ã€‚\nThose who search for a path in darkness are either swallowed by shadows or become a light themselves."
            ],
            'ç™½è±¡å±…': [
                "å¦‚æœåœ¨ç°å®ä¸–ç•Œå¤±å»ä½ ï¼Œé‚£å°±åœ¨å¹³è¡Œä¸–ç•Œé‡å†™æ•…äº‹ï¼Œè®©æˆ‘ä»¬å†ç›¸é‡ã€‚\nIf I lose you in this world, I'll rewrite our story in a parallel universe so we can meet again.",
                "æˆ‘ç›¸ä¿¡ï¼Œå°è¯´é‡Œçš„ä¸–ç•Œå’Œäººï¼Œéƒ½å­˜åœ¨ã€‚\nI believe that the worlds and people in novels truly exist."
            ],
            'é•¿æ±Ÿç´¢é“': [
                "åŸå¸‚æ˜¯æ¯ä½“ï¼Œè€Œæˆ‘ä»¬ç”Ÿæ´»åœ¨å¥¹çš„å­å®«é‡Œ\nThe city is the mother, and we live in her womb",
                "ä½ å½“è¿™æ˜¯å…¬å…±å•æ‰€è¿ˆï¼Œæƒ³æ¥å°±æ¥ï¼Œæƒ³èµ°å°±èµ°\nDo you think this is a public toilet, coming and going as you please?"
            ],
            'çš‡å† å¤§æ‰¶æ¢¯': [
                "æˆ‘ä»¬ç”Ÿæ´»åœ¨é˜´æ²Ÿé‡Œï¼Œä½†ä¾ç„¶æœ‰äººä»°æœ›æ˜Ÿç©ºã€‚\nWe live in the gutter, but some still look up at the stars.",
                "ä»æ¥æ²¡æœ‰ä¸€èŠ‚è¯¾ï¼Œæ•™è¿‡æˆ‘ä»¬å¦‚ä½•å˜æˆå¤§äººã€‚\nThere was never a class that taught us how to become adults.",
                "è·¯ä¸Šæ€»ä¼šæœ‰é˜´å½±ï¼ŒæŠ¬å¤´å°±ä¼šçœ‹åˆ°æ˜Ÿå…‰ã€‚\nThere will always be shadows on the road, but look up and you'll see starlight.",
                "ç”Ÿæ´»ï¼Œå°±åƒå¤å¤©çš„æŸ‘æ©˜æ ‘ï¼ŒæŒ‚ç€é’çš®çš„æœï¼Œè‹¦æ˜¯ä¸€å®šçš„ï¼Œç”œä¹Ÿæœ‰ã€‚\nLife is like a summer citrus tree, bearing green-skinned fruit - bitter for sure, but sweet too.",
                "ä½ ä¿æŠ¤ä¸–ç•Œï¼Œæˆ‘ä¿æŠ¤ä½ ã€‚\nYou protect the world, I'll protect you."
            ],
            'æœå¤©é—¨ç å¤´': [
                "èˆ¹ç¥¨è¿‡æœŸäº†ï¼Œå¯ç å¤´è¿˜åœ¨ç­‰ä¸€ä¸ªæ²¡é å²¸çš„äºº\nThe ticket has expired, but the pier still waits for someone who hasn't docked"
            ],
            'å¼¹å­çŸ³ç å¤´': [
                "å¤§äººæœ‰äº›äº‹æƒ…å°±ä¸èƒ½è·Ÿå°å­©è®²ã€‚\nThere are some things adults can't tell children.",
                "ç°åœ¨è¿™äº›äººæœ€ä¸¥é‡çš„é—®é¢˜ï¼Œä¸æ˜¯ç”Ÿç†æœ‰ç—…ï¼Œè€Œæ˜¯å¿ƒç†æœ‰ç—…ï¼Œçœ‹ä¸Šå»éƒ½ä¸æ€ä¹ˆå¼€å¿ƒçš„ã€‚\nThe most serious problem with people now is not physical illness, but mental illness - they don't seem very happy.",
                "ç–¤ä¹Ÿæ˜¯è‚‰é•¿çš„ï¼Œå·²ç»æˆä¸ºä½ èº«ä½“çš„ä¸€éƒ¨åˆ†äº†ã€‚\nScars are made of flesh too, they've become part of your body.",
                "æ¯ä¸ªäººéƒ½éœ€è¦å¿ƒç†çš„å€¾è¯‰ã€‚\nEveryone needs psychological counseling."
            ],
            'æ¥ç¦å£«': [
                "ç©·äººçš„è°è¯æ˜¯çŸ³å¤´ï¼Œå’½ä¸‹å»æ²‰èƒƒï¼Œåå‡ºæ¥ç ¸è„šã€‚\nA poor person's lies are like stones - swallowed they sink in the stomach, spit out they hit the feet."
            ],
            'å—æ»¨è·¯': [
                "æˆ‘ä»¬ç”Ÿæ´»åœ¨é˜´æ²Ÿé‡Œï¼Œä½†ä¾ç„¶æœ‰äººä»°æœ›æ˜Ÿç©ºã€‚\nWe live in the gutter, but some still look up at the stars.",
                "ä»æ¥æ²¡æœ‰ä¸€èŠ‚è¯¾ï¼Œæ•™è¿‡æˆ‘ä»¬å¦‚ä½•å˜æˆå¤§äººã€‚\nThere was never a class that taught us how to become adults.",
                "è·¯ä¸Šæ€»ä¼šæœ‰é˜´å½±ï¼ŒæŠ¬å¤´å°±ä¼šçœ‹åˆ°æ˜Ÿå…‰ã€‚\nThere will always be shadows on the road, but look up and you'll see starlight.",
                "ç”Ÿæ´»ï¼Œå°±åƒå¤å¤©çš„æŸ‘æ©˜æ ‘ï¼ŒæŒ‚ç€é’çš®çš„æœï¼Œè‹¦æ˜¯ä¸€å®šçš„ï¼Œç”œä¹Ÿæœ‰ã€‚\nLife is like a summer citrus tree, bearing green-skinned fruit - bitter for sure, but sweet too.",
                "ä½ ä¿æŠ¤ä¸–ç•Œï¼Œæˆ‘ä¿æŠ¤ä½ ã€‚\nYou protect the world, I'll protect you."
            ],
            'è€å±…æ°‘æ¥¼': [
                "çŒ«è™½æœ‰ä¹æ¡å‘½, æœ€ç»ˆå´æ­»äºå¥½å¥‡å¿ƒ\nThough a cat has nine lives, it ultimately dies of curiosity",
                "çª¥è§ç§˜å¯†çš„äººï¼Œæœ€åéƒ½æˆäº†ç§˜å¯†çš„çŒç‰©ã€‚\nThose who glimpse secrets eventually become prey to the secrets."
            ]
        };

        const movieData = {
            "é•¿æ±Ÿç´¢é“": {
                 poster: "https://picsum.photos/seed/p_cablecar/100/150",
                 building: "https://picsum.photos/seed/b_cablecar/180/120",
                 quote: "æ±Ÿé£å¸¦ç€ç´¢é“çš„æ­Œè°£ï¼Œé£˜è¿‡æ—¶é—´çš„ç—•è¿¹ã€‚"
             },
             "æ¥ç¦å£«": {
                 poster: "https://picsum.photos/seed/p_raffles/100/150",
                 building: "https://picsum.photos/seed/b_raffles/180/120",
                 quote: "æ‰¬å¸†çš„å»ºç­‘ï¼Œåˆºç ´äº‘å±‚ï¼Œæ˜¯å±±åŸçš„æœªæ¥æƒ³è±¡ã€‚"
             },
            "é˜²ç©ºæ´ç«é”…": {
                 poster: "https://picsum.photos/seed/p_hotpot/100/150",
                 building: "https://picsum.photos/seed/b_hotpot/180/120",
                 quote: "æ´é‡Œçš„çƒ­è¾£ï¼Œæ˜¯è¿™åº§åŸå¸‚çš„åšéŸ§ä¸æ¸©åº¦ã€‚"
             },
            "äº¤é€šèŒ¶é¦†": {
                  poster: "https://picsum.photos/seed/p_tea/100/150",
                  building: "https://picsum.photos/seed/b_tea/180/120",
                  quote: "ä¸€æ¯ç›–ç¢—èŒ¶ï¼ŒåŠæ—¥é—²æ—¶å…‰ï¼Œæ²‰æ·€ç€è€é‡åº†çš„æ…¢ã€‚"
             },
            "æå­å": {
                 poster: "https://picsum.photos/seed/p_liziba/100/150",
                 building: "https://picsum.photos/seed/b_liziba/180/120",
                 quote: "ç©¿æ¥¼è€Œè¿‡çš„ï¼Œä¸åªæ˜¯åˆ—è½¦ï¼Œè¿˜æœ‰ç”Ÿæ´»çš„å¥‡å¹»æ„Ÿã€‚"
             },
            "çš‡å† å¤§æ‰¶æ¢¯": {
                 poster: "https://picsum.photos/seed/p_escalator/100/150",
                 building: "https://picsum.photos/seed/b_escalator/180/120",
                 quote: "äºšæ´²ç¬¬äºŒé•¿ï¼Œè¿æ¥çš„æ˜¯å±±ä¸åŸï¼Œä¸Šä¸ä¸‹ã€‚"
             },
            "æ´ªå´–æ´": {
                 poster: "https://picsum.photos/seed/p_hongya/100/150",
                 building: "https://picsum.photos/seed/b_hongya/180/120",
                 quote: "ç°å®ç‰ˆçš„åƒä¸åƒå¯»ï¼Œç¯ç«è¾‰ç…Œï¼Œæ˜¯ä¸å¤œçš„ç«¥è¯ã€‚"
             },
            "ç£å™¨å£": {
                 poster: "https://picsum.photos/seed/p_ciqi/100/150",
                 building: "https://picsum.photos/seed/b_ciqi/180/120",
                 quote: "é’çŸ³æ¿è·¯ï¼Œéº»èŠ±é£˜é¦™ï¼Œåƒå¹´å¤é•‡çš„æ•…äº‹è¿˜åœ¨è®²ã€‚"
             },
            "DEFAULT": {
                 poster: "https://picsum.photos/seed/p_default/100/150",
                 building: "https://picsum.photos/seed/b_default/180/120",
                 quote: "å±±åŸçš„æ¯ä¸€ä¸ªè§’è½ï¼Œéƒ½å¯èƒ½è—ç€ä¸€ä¸ªæ•…äº‹..."
            }
         };

        const notebook = document.getElementById('notebook');
        const contentDiv = document.getElementById('content');
        const posterImg = document.getElementById('poster');
        const buildingImg = document.getElementById('building');
        const quoteP = document.getElementById('quote');
        const revealBtn = document.getElementById('revealBtn');
        const locationSelect = document.getElementById('location');
        const arrowBtn = document.getElementById('nextPageArrow');
        const nameInput = document.getElementById('name');
        const generateBtn = document.getElementById('generateStoryBtn');
        const storyOutput = document.getElementById('story-output');
        const notebookBack = document.getElementById('notebookBack'); // Get back page element
        const storyGenreDiv = document.getElementById('storyGenre'); // Get genre div

        let isContentShown = false;
        let currentName = "";
        let currentLocation = "";

        // --- Event Listener for Location Change --- 
        locationSelect.addEventListener('change', handleLocationChange);
        nameInput.addEventListener('input', handleInputChange);

        // Function triggered when location dropdown changes
        function handleLocationChange() {
            checkInputsAndUpdateContent();
        }

        // Function triggered when name input changes
        function handleInputChange() {
            // åªæ£€æŸ¥è¾“å…¥æ˜¯å¦å®Œæ•´ï¼Œä¸è§¦å‘å†…å®¹æ›´æ–°
            currentName = nameInput.value.trim();
            if (currentLocation && currentName) {
                arrowBtn.classList.add('enabled');
                arrowBtn.disabled = false;
            } else {
                arrowBtn.classList.remove('enabled');
                arrowBtn.disabled = true;
            }
        }

        // Function to check if both inputs are filled and update content accordingly
        function checkInputsAndUpdateContent() {
            const newLocation = locationSelect.value;
            const newName = nameInput.value.trim();
            
            // æ£€æŸ¥ä½ç½®æˆ–åå­—æ˜¯å¦å‘ç”Ÿå˜åŒ–
            const locationChanged = newLocation !== currentLocation;
            const nameChanged = newName !== currentName;
            
            // æ›´æ–°å½“å‰å€¼
            currentLocation = newLocation;
            currentName = newName;

            if (currentLocation && currentName) { // If both name and location are provided
                // Find the location data from our locations array
                const locationData = locations.find(loc => loc.name === currentLocation);
                
                // Define specific location to movie mappings
                const locationMovieMap = {
                    'åƒå®é—¨å¤§æ¡¥': 'åšå¦‚ç£çŸ³',
                    'å¼¹å­çŸ³ç å¤´': 'ç§˜å²¸',
                    'çš‡å† å¤§æ‰¶æ¢¯': 'å°‘å¹´çš„ä½ ',
                    'å—æ»¨è·¯': 'å°‘å¹´çš„ä½ ',
                    'æå­å': 'é“¤è€Œèµ°é™©',
                    'è€å±…æ°‘æ¥¼': 'å¥½å¥‡å®³æ­»çŒ«',
                    'é•¿æ±Ÿç´¢é“': 'ç–¯ç‹‚çš„çŸ³å¤´',
                    'æ¥ç¦å£«': 'å—ç›Šäºº',
                    'ç™½è±¡å±…': 'åˆºæ€å°è¯´å®¶',
                    'æœå¤©é—¨ç å¤´': 'æ—¥ç…§é‡åº†'
                };
                
                // Find the corresponding movie based on the mapping
                const movieName = locationMovieMap[currentLocation];
                const movieData = movieName ? movies.find(movie => movie.name === movieName) : null;
                
                // Hide content briefly for update
                contentDiv.style.display = 'none';

                // Update content with actual images
                if (movieData) {
                    // If we have a movie related to this location
                    if (Array.isArray(movieData.image)) {
                        // Special handling for "å°‘å¹´çš„ä½ " movie
                        if (movieName === 'å°‘å¹´çš„ä½ ') {
                            if (currentLocation === 'çš‡å† å¤§æ‰¶æ¢¯') {
                                // Use first image for çš‡å† å¤§æ‰¶æ¢¯
                                posterImg.src = movieData.image[0];
                            } else if (currentLocation === 'å—æ»¨è·¯') {
                                // Use second image for å—æ»¨è·¯
                                posterImg.src = movieData.image[1];
                            }
                        } else {
                            // For other movies with multiple images, use the first one
                            posterImg.src = movieData.image[0];
                        }
                    } else {
                        posterImg.src = movieData.image;
                    }
                    posterImg.alt = movieData.name + " æµ·æŠ¥";
                } else {
                    // If no movie is found, use a default image
                    posterImg.src = "assets/images/é‡åº†å¤œæ™¯.jpg";
                    posterImg.alt = "é‡åº†å¤œæ™¯";
                }
                
                // Set the building image from our locations array
                buildingImg.src = locationData ? locationData.image : "assets/images/é‡åº†å¤œæ™¯.jpg";
                buildingImg.alt = currentLocation + " å®æ™¯";
                
                // Set the quote from our quotes array
                const locationQuotes = quotes[currentLocation];
                if (locationQuotes && locationQuotes.length > 0) {
                    const randomQuote = locationQuotes[Math.floor(Math.random() * locationQuotes.length)];
                    const [chinese, english] = randomQuote.split('\n');
                    
                    // Split Chinese text into sentences based on punctuation marks
                    const chineseSentences = chinese.split(/[ï¼Œã€‚ï¼ï¼Ÿã€]/).filter(s => s.trim());
                    const chineseHTML = chineseSentences.map(s => `<span class="chinese">${s.trim()}</span>`).join('');
                    
                    // Split English text into sentences based on punctuation marks
                    const englishSentences = english.split(/[,.!?]/).filter(s => s.trim());
                    const englishHTML = englishSentences.map(s => `<span class="english">${s.trim()}</span>`).join('');
                    
                    quoteP.innerHTML = chineseHTML + englishHTML;
                    
                    // æ·»åŠ ç²’å­æ•ˆæœäº‹ä»¶ç›‘å¬
                    setTimeout(() => {
                        const chineseSpans = quoteP.querySelectorAll('.chinese span');
                        const englishSpans = quoteP.querySelectorAll('.english span');
                        
                        // ä¸ºæ¯ä¸ªæ–‡å­—ç‰‡æ®µæ·»åŠ é¼ æ ‡ç§»åŠ¨äº‹ä»¶
                        [...chineseSpans, ...englishSpans].forEach(span => {
                            span.addEventListener('mousemove', (e) => {
                                createTextParticles(span, e);
                            });
                        });
                    }, 100);
                } else {
                    quoteP.textContent = "é‡åº†çš„æ¯ä¸€ä¸ªè§’è½ï¼Œéƒ½å¯èƒ½è—ç€ä¸€ä¸ªæ•…äº‹...";
                }

                // Show content after a small delay
                setTimeout(() => {
                    contentDiv.style.display = 'flex';
                    isContentShown = true;
                    // ç¡®ä¿ç®­å¤´æŒ‰é’®å§‹ç»ˆå¯ç”¨
                    arrowBtn.classList.add('enabled');
                    arrowBtn.disabled = false;
                }, 50); 

                // åªåœ¨ä»¥ä¸‹æƒ…å†µé‡ç½®åé¡µï¼š
                // 1. å½“å‰ä¸åœ¨ç¬¬äºŒé¡µï¼ˆnotebookæ²¡æœ‰flippedç±»ï¼‰
                // 2. æˆ–è€…å½“å‰æ²¡æœ‰ç”Ÿæˆçš„æ•…äº‹å†…å®¹
                // 3. æˆ–è€…ä½ç½®æˆ–åå­—å‘ç”Ÿäº†å˜åŒ–
                if (!notebook.classList.contains('flipped') || 
                    storyOutput.innerHTML.trim() === '' || 
                    locationChanged || 
                    nameChanged) {
                    resetBackPage();
                }

            } else { // If either name or location is missing
                contentDiv.style.display = 'none';
                isContentShown = false;
                arrowBtn.classList.remove('enabled');
                arrowBtn.disabled = true;
                resetBackPage(); // å½“è¾“å…¥ä¸å®Œæ•´æ—¶é‡ç½®åé¡µ
            }
        }

        function slidePage() {
            notebook.classList.add('flipped');
            
            // å¯ç”¨è¿”å›æŒ‰é’®
            const backArrow = document.querySelector('.back-page-arrow');
            if (backArrow) {
                backArrow.classList.add('enabled');
            }
            
            // ç¡®ä¿ç”ŸæˆæŒ‰é’®å¯è§ä¸”å¯ç”¨
            const generateBtn = document.getElementById('generateStoryBtn');
            if (generateBtn) {
                generateBtn.style.display = 'inline-block';
                generateBtn.disabled = false;
            }
            
            // æ£€æŸ¥æ•…äº‹å†…å®¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            if (storyOutput.innerHTML.trim() !== '' && !storyOutput.querySelector('.loading')) {
                const saveButton = document.getElementById('saveAsImageBtn');
                if (saveButton) {
                    saveButton.style.display = 'inline-block';
                }
            } else {
                // å¦‚æœæ•…äº‹å†…å®¹ä¸å­˜åœ¨æˆ–æ­£åœ¨åŠ è½½ï¼Œéšè—ä¿å­˜æŒ‰é’®
                const saveButton = document.getElementById('saveAsImageBtn');
                if (saveButton) {
                    saveButton.style.display = 'none';
                }
            }
            
            // é‡ç½®æ•…äº‹è¾“å‡ºåŒºåŸŸ
            if (storyOutput.innerHTML.trim() === '') {
                storyOutput.style.display = 'none';
                storyOutput.classList.remove('visible');
            }
        }

        function slideBack() {
            notebook.classList.remove('flipped');
            
            // å¯ç”¨è¿”å›æŒ‰é’®
            const backArrow = document.querySelector('.back-page-arrow');
            if (backArrow) {
                backArrow.classList.remove('enabled');
            }
            
            // ç¡®ä¿ç®­å¤´æŒ‰é’®ä¿æŒå¯ç”¨çŠ¶æ€
            if (currentLocation && currentName) {
                arrowBtn.classList.add('enabled');
                arrowBtn.disabled = false;
            }
        }

        function resetBackPage() {
            storyGenreDiv.textContent = ''; // Clear genre text
            storyOutput.innerHTML = ''; // Clear story
            storyOutput.classList.remove('visible'); // Remove visible class
            storyOutput.style.display = 'none'; // Hide the container
            generateBtn.style.display = 'inline-block'; // Show generate button
            generateBtn.disabled = false;
            // Remove specific style classes
            notebookBack.classList.remove('style-light', 'style-dark');
            
            // ç¡®ä¿ä¿å­˜æŒ‰é’®éšè—
            const saveButton = document.getElementById('saveAsImageBtn');
            if (saveButton) {
                saveButton.style.display = 'none';
            }
            
            // é‡ç½®ç”ŸæˆçŠ¶æ€
            isGeneratingStory = false;
        }

        contentDiv.style.display = 'none';
        arrowBtn.classList.remove('enabled');
        arrowBtn.disabled = true; // Ensure arrow starts disabled
        locationSelect.value = "";

        // Updated API call function to request both Chinese and English versions
        async function callDeepSeekAPI(name, location, genre) {
             console.log(`Calling DeepSeek for: ${name} at ${location} with pre-selected genre: ${genre}`);
            const apiKey = 'sk-0c23a925f8ff472780c31e41fe82d422';
            const apiUrl = 'https://api.deepseek.com/v1/chat/completions';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{
                            role: "user",
                            content: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°è¯´å®¶ï¼Œæ“…é•¿åˆ›ä½œå„ç§é£æ ¼çš„æ•…äº‹ã€‚è¯·åˆ›ä½œä¸€ä¸ªä¸¥æ ¼éµå¾ª**${genre}**é£æ ¼çš„æ•…äº‹æƒ…èŠ‚ç‰‡æ®µï¼ˆçº¦200å­—ï¼‰ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

1. ä¸»è§’å«${name}ï¼Œæ•…äº‹å‘ç”Ÿåœ¨é‡åº†çš„${location}ã€‚

2. æ•…äº‹å†…å®¹å¿…é¡»ä¸¥æ ¼ç¬¦åˆæ‰€é€‰é£æ ¼ï¼Œæ¯ç§é£æ ¼éƒ½æœ‰å…¶ç‹¬ç‰¹çš„ç‰¹å¾å’Œå…ƒç´ ï¼š

   - **å–œå‰§**ï¼šå¿…é¡»åŒ…å«å¹½é»˜å…ƒç´ ã€è½»æ¾è¯™è°çš„æƒ…èŠ‚ï¼Œå¯ä»¥æœ‰è¯¯ä¼šã€å·§åˆç­‰å–œå‰§å…ƒç´ ã€‚æ•…äº‹åº”è¯¥è®©è¯»è€…æ„Ÿåˆ°è½»æ¾æ„‰å¿«ï¼Œå¯ä»¥åŒ…å«å¤¸å¼ çš„æƒ…èŠ‚ã€æ»‘ç¨½çš„å¯¹è¯æˆ–å¹½é»˜çš„è¯¯ä¼šã€‚
   
   - **æ²»æ„ˆ**ï¼šå¿…é¡»åŒ…å«æ¸©æš–ã€å®‰æ…°ã€å¸Œæœ›çš„å…ƒç´ ï¼Œä¸»è§’åº”è¯¥ç»å†å›°éš¾æˆ–è·å¾—å®‰æ…°ã€‚æ•…äº‹åº”è¯¥ä¼ é€’æ­£èƒ½é‡ï¼Œå¯ä»¥åŒ…å«å†…å¿ƒæˆé•¿ã€æƒ…æ„Ÿæ²»æ„ˆæˆ–æ¸©æš–äººå¿ƒçš„å¯¹è¯ã€‚
   
   - **åŠ¨ä½œ**ï¼šå¿…é¡»åŒ…å«åŠ¨ä½œåœºæ™¯ã€ç´§å¼ åˆºæ¿€çš„æƒ…èŠ‚ï¼Œå¯ä»¥æœ‰è¿½é€ã€æ‰“æ–—ç­‰å…ƒç´ ã€‚æ•…äº‹åº”è¯¥å……æ»¡åŠ¨æ„Ÿï¼Œå¯ä»¥åŒ…å«æ¿€çƒˆçš„å†²çªã€ç´§å¼ çš„è¿½é€æˆ–æƒŠé™©çš„é€ƒç”Ÿã€‚
   
   - **çŠ¯ç½ª**ï¼šå¿…é¡»åŒ…å«çŠ¯ç½ªå…ƒç´ ã€æ‚¬ç–‘æ¨ç†ï¼Œå¯ä»¥æœ‰çŠ¯ç½ªåŠ¨æœºã€è°ƒæŸ¥è¿‡ç¨‹ç­‰ã€‚æ•…äº‹åº”è¯¥æ¶‰åŠè¿æ³•è¡Œä¸ºæˆ–è°ƒæŸ¥ï¼Œå¯ä»¥åŒ…å«çŠ¯ç½ªè®¡åˆ’ã€è­¦æ–¹è°ƒæŸ¥æˆ–çŠ¯ç½ªå¿ƒç†ã€‚
   
   - **çˆ±æƒ…**ï¼šå¿…é¡»åŒ…å«çˆ±æƒ…å…ƒç´ ã€æƒ…æ„Ÿçº è‘›ï¼Œå¯ä»¥æœ‰ç›¸é‡ã€å¿ƒåŠ¨ã€çŸ›ç›¾ç­‰ã€‚æ•…äº‹åº”è¯¥å›´ç»•æ„Ÿæƒ…å±•å¼€ï¼Œå¯ä»¥åŒ…å«æµªæ¼«é‚‚é€…ã€æƒ…æ„Ÿå†²çªæˆ–å†…å¿ƒæŒ£æ‰ã€‚
   
   - **ç«¥è¯**ï¼šå¿…é¡»åŒ…å«å¥‡å¹»å…ƒç´ ã€ç¾å¥½æƒ³è±¡ï¼Œå¯ä»¥æœ‰é­”æ³•ã€ç²¾çµã€æ„¿æœ›ç­‰ã€‚æ•…äº‹åº”è¯¥å……æ»¡æƒ³è±¡åŠ›å’Œç¾å¥½ï¼Œå¯ä»¥åŒ…å«é­”æ³•å…ƒç´ ã€ç¥å¥‡ç”Ÿç‰©æˆ–ç¾å¥½æ„¿æœ›ã€‚
   
   - **é’æ˜¥**ï¼šå¿…é¡»åŒ…å«æˆé•¿å…ƒç´ ã€é’æ˜¥æ´»åŠ›ï¼Œå¯ä»¥æœ‰å‹æƒ…ã€æ¢¦æƒ³ã€å›é€†ç­‰ã€‚æ•…äº‹åº”è¯¥ä½“ç°å¹´è½»äººçš„ç‰¹ç‚¹ï¼Œå¯ä»¥åŒ…å«æ ¡å›­ç”Ÿæ´»ã€é’æ˜¥æ¢¦æƒ³æˆ–æˆé•¿å›°æƒ‘ã€‚
   
   - **æ‚¬ç–‘**ï¼šå¿…é¡»åŒ…å«è°œå›¢ã€çº¿ç´¢ã€æ¨ç†ï¼Œå¯ä»¥æœ‰ç¥ç§˜äº‹ä»¶ã€è°ƒæŸ¥è¿‡ç¨‹ç­‰ã€‚æ•…äº‹åº”è¯¥å……æ»¡æ‚¬å¿µï¼Œå¯ä»¥åŒ…å«æœªè§£ä¹‹è°œã€éšè—çº¿ç´¢æˆ–æ¨ç†è¿‡ç¨‹ã€‚
   
   - **ææ€–**ï¼šå¿…é¡»åŒ…å«ææ€–å…ƒç´ ã€ç´§å¼ æ°›å›´ï¼Œå¯ä»¥æœ‰è¶…è‡ªç„¶ç°è±¡ã€ææƒ§å¿ƒç†ç­‰ã€‚æ•…äº‹åº”è¯¥ä»¤äººæ„Ÿåˆ°ææƒ§ï¼Œå¯ä»¥åŒ…å«è¯¡å¼‚ç°è±¡ã€ææ€–æ°›å›´æˆ–å¿ƒç†ææƒ§ã€‚
   
   - **æƒŠæ‚š**ï¼šå¿…é¡»åŒ…å«ç´§å¼ åˆºæ¿€ã€å±é™©å¨èƒï¼Œå¯ä»¥æœ‰å±é™©æƒ…å¢ƒã€é€ƒç”Ÿè¿‡ç¨‹ç­‰ã€‚æ•…äº‹åº”è¯¥ä»¤äººæ„Ÿåˆ°ç´§å¼ ï¼Œå¯ä»¥åŒ…å«å±é™©åœºæ™¯ã€ç´§å¼ æ°›å›´æˆ–æƒŠé™©é€ƒç”Ÿã€‚
   
   - **å¹»æƒ³**ï¼šå¿…é¡»åŒ…å«å¥‡å¹»å…ƒç´ ã€è¶…ç°å®æƒ…èŠ‚ï¼Œå¯ä»¥æœ‰é­”æ³•ã€å¼‚ä¸–ç•Œã€ç‰¹æ®Šèƒ½åŠ›ç­‰ã€‚æ•…äº‹åº”è¯¥å……æ»¡æƒ³è±¡åŠ›ï¼Œå¯ä»¥åŒ…å«å¥‡å¹»ä¸–ç•Œã€ç‰¹æ®Šèƒ½åŠ›æˆ–è¶…ç°å®å…ƒç´ ã€‚
   
   - **ç§‘å¹»**ï¼šå¿…é¡»åŒ…å«ç§‘æŠ€å…ƒç´ ã€æœªæ¥æƒ³è±¡ï¼Œå¯ä»¥æœ‰æœªæ¥ç§‘æŠ€ã€å¤ªç©ºæ¢ç´¢ã€äººå·¥æ™ºèƒ½ç­‰ã€‚æ•…äº‹åº”è¯¥æ¶‰åŠç§‘æŠ€ï¼Œå¯ä»¥åŒ…å«æœªæ¥ç§‘æŠ€ã€å¤ªç©ºæ¢ç´¢æˆ–äººå·¥æ™ºèƒ½ã€‚

3. æ–‡å­—é£æ ¼è¦æ±‚ï¼š
   - æ–‡å­—é£æ ¼å¿…é¡»ä¸æŒ‡å®šçš„${genre}é£æ ¼å®Œå…¨èåˆï¼Œä½¿ç”¨ç¬¦åˆè¯¥é£æ ¼çš„è¯æ±‡å’Œå¥å¼ã€‚
   - å¯¹ç™½å¯ä»¥æºæ‚é‡åº†æ–¹è¨€ã€‚
   - åªèƒ½åŒ…å«ä¸€ä¸ªåœ°ç‚¹å’Œä¸¤è‡³ä¸‰ä¸ªäººç‰©ã€‚
   - æ•…äº‹é€»è¾‘å‰åè¿è´¯ï¼Œä¸èƒ½çŸ›ç›¾ã€‚
   - æ•…äº‹çš„æ–‡ç¬”æµç•…ï¼Œç•¥å¸¦æ–‡è‰ºæ°”æ¯ã€‚

4. æ ¼å¼è¦æ±‚ï¼š
   - åŒ…å«æ ‡é¢˜ï¼ˆç”¨ã€Œã€æ‹¬èµ·ï¼‰ã€‚
   - **ä¸è¦**åœ¨å¼€å¤´åŒ…å«"é£æ ¼ï¼š..."æˆ–ä»»ä½•é£æ ¼æ ‡ç­¾ã€‚

5. è¯·åŒæ—¶æä¾›è‹±æ–‡ç‰ˆæœ¬ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

ä¸­æ–‡æ•…äº‹ï¼š
[ä½ çš„ä¸­æ–‡æ•…äº‹]

[æ ‡é¢˜åŒæ ·ç”¨ã€Œã€æ‹¬èµ·ï¼Œå¹¶å±…ä¸­æ˜¾ç¤ºï¼Œä¸è¦åœ¨ä¸­è‹±æ–‡ç‰ˆæœ¬ä¹‹é—´å‡ºç°ä»»ä½•ç¿»è¯‘æˆ–ç‰ˆæœ¬ç›¸å…³çš„è¯è¯­æˆ–æ ‡è®°ï¼Œæ¯”å¦‚è‹±æ–‡æ•…äº‹ã€è‹±æ–‡ç¿»è¯‘ã€è‹±æ–‡ç‰ˆæœ¬ç­‰]`
                        }],
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    let errorMsg = `API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorBody);
                        if (errorJson.error && errorJson.error.message) {
                            errorMsg += ` - ${errorJson.error.message}`;
                        }
                    } catch(e) { /* Ignore parsing error */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                     // API now returns both Chinese and English versions
                     let storyText = data.choices[0].message.content.trim();
                     
                     // Split the content into Chinese and English parts
                     const chineseMatch = storyText.match(/ä¸­æ–‡æ•…äº‹ï¼š\n([\s\S]*?)(?=\n\n|$)/);
                     const englishMatch = storyText.match(/\n\n([\s\S]*?)$/);
                     
                     let chineseStory = chineseMatch ? chineseMatch[1].trim() : storyText;
                     let englishStory = englishMatch ? englishMatch[1].trim() : '';
                     
                     // Remove any occurrence of "è‹±æ–‡ç¿»è¯‘ï¼š" text and clean up the English story
                     englishStory = englishStory
                         .replace(/è‹±æ–‡ç¿»è¯‘ï¼š\s*/g, '')
                         .replace(/^è‹±æ–‡ç¿»è¯‘\s*/g, '')
                         .replace(/^\(è‹±æ–‡ç¿»è¯‘\)\s*/g, '')
                         .replace(/^è‹±æ–‡ï¼š\s*/g, '')
                         .replace(/^è‹±æ–‡ç‰ˆï¼š\s*/g, '')
                         .replace(/^English versionï¼š\s*/g, '')
                         .replace(/^Englishï¼š\s*/g, '')
                         .replace(/^English translationï¼š\s*/g, '')
                         .replace(/è‹±æ–‡ç¿»è¯‘ï¼š/g, '')
                         .replace(/è‹±æ–‡ç¿»è¯‘/g, '')
                         .replace(/\(è‹±æ–‡ç¿»è¯‘\)/g, '')
                         .replace(/è‹±æ–‡ï¼š/g, '')
                         .replace(/è‹±æ–‡ç‰ˆï¼š/g, '')
                         .replace(/English versionï¼š/g, '')
                         .replace(/Englishï¼š/g, '')
                         .replace(/English translationï¼š/g, '')
                         .replace(/è‹±æ–‡ç‰ˆæœ¬ï¼š/g, '')
                         .replace(/è‹±æ–‡ç‰ˆæœ¬/g, '')
                         .replace(/\(è‹±æ–‡ç‰ˆæœ¬\)/g, '')
                         .replace(/ç‰ˆæœ¬ï¼š/g, '')
                         .replace(/versionï¼š/g, '')
                         .replace(/ç¿»è¯‘ï¼š/g, '')
                         .replace(/translationï¼š/g, '')
                         .replace(/translation/g, '')
                         .replace(/translated versionï¼š/g, '')
                         .replace(/translated version/g, '')
                         .replace(/translatedï¼š/g, '')
                         .replace(/translated/g, '')
                         .replace(/version/g, '')
                         .replace(/è‹±æ–‡/g, '')
                         .replace(/English/g, '')
                         .trim();
                     
                     // Check if the content already contains both Chinese and English
                     // If the content contains "ä¸­æ–‡æ•…äº‹ï¼š" marker, it's already formatted
                     const hasFormattedContent = storyText.includes("ä¸­æ–‡æ•…äº‹ï¼š");
                     
                     // If the content is already formatted, use it directly
                     if (hasFormattedContent) {
                         // --- Format Chinese Story --- 
                         let processedChineseStory = '';
                         const chineseParts = chineseStory.split(/(\n\s*\n)/);
                         let isFirstParagraph = true;
                         chineseParts.forEach(part => {
                             const trimmedPart = part.trim();
                             if (trimmedPart.length === 0) return;
                             if (/^\n\s*\n$/.test(part)) return;

                             const titleMatch = trimmedPart.match(/^ã€Œ(.*?)ã€$/);
                             if (titleMatch && isFirstParagraph) {
                                 processedChineseStory += `<p><strong>ã€Œ${titleMatch[1]}ã€</strong></p>`;
                             } else {
                                 processedChineseStory += `<p>${trimmedPart.replace(/\n/g, '<br>')}</p>`;
                             }
                             isFirstParagraph = false;
                         });
                         
                         // --- Format English Story --- 
                         let processedEnglishStory = '';
                         if (englishStory) {
                             const englishParts = englishStory.split(/(\n\s*\n)/);
                             isFirstParagraph = true;
                             englishParts.forEach(part => {
                                 const trimmedPart = part.trim();
                                 if (trimmedPart.length === 0) return;
                                 if (/^\n\s*\n$/.test(part)) return;
                                 
                                 // Check for title in various formats
                                 const titleMatch = trimmedPart.match(/^"(.*?)"$/) || 
                                                   trimmedPart.match(/^ã€Œ(.*?)ã€$/) || 
                                                   trimmedPart.match(/^'(.*?)'$/);
                                 
                                 if (titleMatch && isFirstParagraph) {
                                     processedEnglishStory += `<p class="english"><strong>ã€Œ${titleMatch[1]}ã€</strong></p>`;
                                 } else {
                                     processedEnglishStory += `<p class="english">${trimmedPart.replace(/\n/g, '<br>')}</p>`;
                                 }
                                 isFirstParagraph = false;
                             });
                         }
                         
                         // Combine Chinese and English stories
                         return processedChineseStory + processedEnglishStory;
                     } else {
                         // If the content is not formatted, process it as a single story
                         let processedStory = '';
                         const parts = storyText.split(/(\n\s*\n)/);
                         let isFirstParagraph = true;
                         
                         parts.forEach(part => {
                             const trimmedPart = part.trim();
                             if (trimmedPart.length === 0) return;
                             if (/^\n\s*\n$/.test(part)) return;
                             
                             const titleMatch = trimmedPart.match(/^ã€Œ(.*?)ã€$/);
                             if (titleMatch && isFirstParagraph) {
                                 processedStory += `<p><strong>ã€Œ${titleMatch[1]}ã€</strong></p>`;
                             } else {
                                 processedStory += `<p>${trimmedPart.replace(/\n/g, '<br>')}</p>`;
                             }
                             isFirstParagraph = false;
                         });
                         
                         return processedStory;
                     }
                 } else {
                     console.error("Invalid API response structure:", data);
                     throw new Error('ä»APIæ”¶åˆ°äº†æ— æ•ˆçš„å“åº”ç»“æ„');
                 }
            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                throw error;
            }
         }

        // åœ¨JavaScriptéƒ¨åˆ†æ·»åŠ ä¸€ä¸ªæ ‡å¿—å˜é‡
        let isGeneratingStory = false;

        async function generateStory(event) {
            // é˜²æ­¢é‡å¤ç”Ÿæˆ
            if (isGeneratingStory) return;
            isGeneratingStory = true;
            
            const name = nameInput.value.trim();
            const location = locationSelect.value;

            if (!name || !location) {
                alert("è¯·è¾“å…¥åå­—å’Œé€‰æ‹©åœ°ç‚¹");
                isGeneratingStory = false;
                return;
            }

            // éšè—ä¿å­˜æŒ‰é’®ï¼Œç›´åˆ°æ•…äº‹ç”Ÿæˆå®Œæˆ
            const saveButton = document.getElementById('saveAsImageBtn');
            if (saveButton) {
                saveButton.style.display = 'none';
            }

            // Show the story output container with animation
            storyOutput.style.display = 'block';
            setTimeout(() => {
                storyOutput.classList.add('visible');
            }, 50);

            // Show loading state with percentage animation
            storyOutput.innerHTML = `
                <div class="loading" style="font-family: 'Lenyah' !important;">
                    <div class="loading-text" style="font-family: 'Lenyah' !important;">Generating story</div>
                    <div class="loading-percentage" style="font-family: 'Lenyah' !important;">1%</div>
                    <div class="loading-bar">
                        <div class="loading-bar-fill">
                            <div class="camera-icon">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Camera body -->
                                    <rect x="4" y="6" width="16" height="12" rx="2" 
                                          fill="url(#cameraBodyGradient)"/>
                                    
                                    <!-- Main lens -->
                                    <circle cx="12" cy="12" r="3" 
                                            fill="url(#cameraLensGradient)"/>
                                    <circle cx="12" cy="12" r="2.5" 
                                            stroke="url(#cameraDetailGradient)" 
                                            stroke-width="0.5"/>
                                    <circle cx="12" cy="12" r="1.5" 
                                            fill="url(#cameraDetailGradient)"/>
                                    
                                    <!-- Viewfinder -->
                                    <rect x="16" y="8" width="2" height="2" rx="0.5"
                                          fill="url(#cameraDetailGradient)"/>
                                    
                                    <!-- Shutter button -->
                                    <circle cx="18" cy="12" r="0.8" 
                                            fill="url(#cameraDetailGradient)"/>
                                    
                                    <!-- Gradient definitions -->
                                    <defs>
                                        <linearGradient id="cameraBodyGradient" x1="4" y1="6" x2="20" y2="18" gradientUnits="userSpaceOnUse">
                                            <stop offset="0%" stop-color="#00FFC8"/>
                                            <stop offset="25%" stop-color="#80FFE4"/>
                                            <stop offset="50%" stop-color="#FF006F"/>
                                            <stop offset="75%" stop-color="#FF80B7"/>
                                            <stop offset="100%" stop-color="#00FFC8"/>
                                        </linearGradient>
                                        
                                        <linearGradient id="cameraDetailGradient" x1="4" y1="4" x2="20" y2="20" gradientUnits="userSpaceOnUse">
                                            <stop offset="0%" stop-color="#00FFFF"/>
                                            <stop offset="50%" stop-color="#FF00FF"/>
                                            <stop offset="100%" stop-color="#00FFFF"/>
                                        </linearGradient>
                                        
                                        <linearGradient id="cameraLensGradient" x1="9" y1="9" x2="15" y2="15" gradientUnits="userSpaceOnUse">
                                            <stop offset="0%" stop-color="#00FFFF"/>
                                            <stop offset="25%" stop-color="#80FFFF"/>
                                            <stop offset="50%" stop-color="#FF00FF"/>
                                            <stop offset="75%" stop-color="#FF80FF"/>
                                            <stop offset="100%" stop-color="#00FFFF"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Get the loading elements
            const percentageElement = storyOutput.querySelector('.loading-percentage');
            const barFillElement = storyOutput.querySelector('.loading-bar-fill');
            
            // Start the percentage animation
            let percentage = 1;
            const percentageInterval = setInterval(() => {
                // ä½¿ç”¨æ›´å¹³æ»‘çš„è¿›åº¦å¢é•¿ç®—æ³•
                if (percentage < 30) {
                    // å¼€å§‹æ—¶å¢é•¿è¾ƒå¿«
                    percentage += Math.floor(Math.random() * 2) + 1;
                } else if (percentage < 70) {
                    // ä¸­é—´å¢é•¿é€‚ä¸­
                    percentage += Math.floor(Math.random() * 1.5) + 0.5;
                } else if (percentage < 90) {
                    // åæœŸå¢é•¿å˜æ…¢
                    percentage += Math.floor(Math.random() * 1) + 0.2;
                } else if (percentage < 98) {
                    // æ¥è¿‘å®Œæˆæ—¶å¢é•¿éå¸¸æ…¢
                    percentage += Math.floor(Math.random() * 0.5) + 0.1;
                } else if (percentage < 99) {
                    // 99%æ—¶å‡ ä¹åœæ­¢
                    percentage = 99;
                }
                
                // ç¡®ä¿ä¸è¶…è¿‡99%å¹¶å–æ•´
                if (percentage > 99) percentage = 99;
                const displayPercentage = Math.floor(percentage);
                
                percentageElement.textContent = `${displayPercentage}%`;
                barFillElement.style.width = `${percentage}%`;
            }, 100);
            
            storyGenreDiv.textContent = ''; // Clear previous genre text
            generateBtn.disabled = true;
            notebookBack.classList.remove('style-light', 'style-dark'); // Reset styles

            try {
                // Select a genre randomly from the list
                const allGenres = ['å–œå‰§', 'æ²»æ„ˆ', 'åŠ¨ä½œ', 'çŠ¯ç½ª', 'çˆ±æƒ…', 'ç«¥è¯', 'é’æ˜¥', 'æ‚¬ç–‘', 'ææ€–', 'æƒŠæ‚š', 'å¹»æƒ³', 'ç§‘å¹»'];
                const genreTranslations = {
                    'å–œå‰§': 'comedy',
                    'æ²»æ„ˆ': 'healing',
                    'åŠ¨ä½œ': 'action',
                    'çŠ¯ç½ª': 'crime',
                    'çˆ±æƒ…': 'romance',
                    'ç«¥è¯': 'fairy tale',
                    'é’æ˜¥': 'youth',
                    'æ‚¬ç–‘': 'mystery',
                    'ææ€–': 'horror',
                    'æƒŠæ‚š': 'thriller',
                    'å¹»æƒ³': 'fantasy',
                    'ç§‘å¹»': 'science fiction'
                };
                const selectedGenre = allGenres[Math.floor(Math.random() * allGenres.length)];
                const genreTranslation = genreTranslations[selectedGenre] || selectedGenre;
                console.log("Client selected genre:", selectedGenre);

                // Display the genre text in English format with Chinese genre and English translation
                storyGenreDiv.textContent = `${name}'s story style: ${selectedGenre} (${genreTranslation})`;

                // è®°å½•APIè°ƒç”¨å¼€å§‹æ—¶é—´
                const apiStartTime = Date.now();
                
                // Call API with the selected genre
                const story = await callDeepSeekAPI(name, location, selectedGenre);
                
                // è®¡ç®—APIè°ƒç”¨å®é™…è€—æ—¶
                const apiDuration = Date.now() - apiStartTime;
                
                // æ ¹æ®APIå®é™…è€—æ—¶è°ƒæ•´åŠ è½½åŠ¨ç”»
                clearInterval(percentageInterval);
                
                // å¦‚æœAPIè°ƒç”¨æ—¶é—´çŸ­ï¼Œæ·»åŠ ä¸€ä¸ªå¹³æ»‘è¿‡æ¸¡åˆ°100%
                if (apiDuration < 2000) {
                    // å¿«é€Ÿè¿‡æ¸¡åˆ°100%
                    percentageElement.textContent = '100%';
                    barFillElement.style.width = '100%';
                    
                    // çŸ­å»¶è¿Ÿåæ˜¾ç¤ºæ•…äº‹
                    setTimeout(() => {
                        storyOutput.innerHTML = story;
                        generateBtn.style.display = 'none';
                        // æ˜¾ç¤ºä¿å­˜æŒ‰é’® - ç¡®ä¿æ•…äº‹å†…å®¹å·²ç»åŠ è½½
                        if (saveButton && storyOutput.innerHTML.trim() !== '') {
                            saveButton.style.display = 'inline-block';
                        }
                        animateStoryOutput(); // Add animation
                    }, 300);
                } else {
                    // å¦‚æœAPIè°ƒç”¨æ—¶é—´é•¿ï¼Œç›´æ¥æ˜¾ç¤ºæ•…äº‹
                    percentageElement.textContent = '100%';
                    barFillElement.style.width = '100%';
                    storyOutput.innerHTML = story;
                    generateBtn.style.display = 'none';
                    // æ˜¾ç¤ºä¿å­˜æŒ‰é’® - ç¡®ä¿æ•…äº‹å†…å®¹å·²ç»åŠ è½½
                    if (saveButton && storyOutput.innerHTML.trim() !== '') {
                        saveButton.style.display = 'inline-block';
                    }
                    animateStoryOutput(); // Add animation
                }
                
             } catch (error) {
                 console.error("Error generating story:", error);
                 clearInterval(percentageInterval);
                storyOutput.innerHTML = `<p class="error">ç”Ÿæˆæ•…äº‹æ—¶å‡ºé”™: ${error.message}</p>`;
                generateBtn.style.display = 'inline-block';
                generateBtn.disabled = false;
                // å‡ºé”™æ—¶ä¸æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                if (saveButton) {
                    saveButton.style.display = 'none';
                }
            } finally {
                // ç¡®ä¿æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½é‡ç½®æ ‡å¿—
                isGeneratingStory = false;
            }
        }

        function updateLocationSelect() {
            locationSelect.innerHTML = '<option value="" disabled selected>select a place</option>';
            const locationNames = {
                'åƒå®é—¨å¤§æ¡¥': 'Qiansimen Bridge',
                'æå­å': 'Liziba',
                'ç™½è±¡å±…': 'Baixiangju',
                'é•¿æ±Ÿç´¢é“': 'Yangtze River Cableway',
                'çš‡å† å¤§æ‰¶æ¢¯': 'Crown Escalator',
                'æœå¤©é—¨ç å¤´': 'Chaotianmen Dock',
                'å¼¹å­çŸ³ç å¤´': 'Danzi Stone Dock',
                'æ¥ç¦å£«': 'Raffles City',
                'å—æ»¨è·¯': 'Nanbin Road',
                'è€å±…æ°‘æ¥¼': 'Old Residential Building'
            };
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.name;
                option.textContent = `${location.name} (${locationNames[location.name]})`;
                locationSelect.appendChild(option);
            });
        }

        function updateMoviePoster() {
            const selectedLocation = locationSelect.value;
            const moviePoster = document.getElementById('moviePoster');
            const movieTitle = document.getElementById('movieTitle');
            const movieQuote = document.getElementById('movieQuote');
            
            if (selectedLocation) {
                const locationData = movieData[selectedLocation];
                if (locationData) {
                    movieTitle.textContent = locationData.title;
                    moviePoster.src = locationData.poster;
                    movieQuote.textContent = locationData.quote;
                } else {
                    // å¦‚æœæ²¡æœ‰ç”µå½±æ•°æ®ï¼Œæ˜¾ç¤ºéšæœºå°è¯
                    const locationQuotes = quotes[selectedLocation];
                    if (locationQuotes) {
                        const randomQuote = locationQuotes[Math.floor(Math.random() * locationQuotes.length)];
                        movieQuote.textContent = randomQuote;
                    }
                    movieTitle.textContent = "é‡åº†æ•…äº‹";
                    moviePoster.src = "assets/images/é‡åº†å¤œæ™¯.jpg";
                }
            } else {
                movieTitle.textContent = "è¯·é€‰æ‹©åœ°ç‚¹";
                moviePoster.src = "assets/images/é‡åº†å¤œæ™¯.jpg";
                movieQuote.textContent = "";
            }
        }

        function updateBuildingImage() {
            const selectedLocation = locationSelect.value;
            const buildingImg = document.getElementById('buildingImg');
            
            if (selectedLocation) {
                const location = locations.find(loc => loc.name === selectedLocation);
                if (location) {
                    buildingImg.src = location.image;
                }
            } else {
                buildingImg.src = "assets/images/é‡åº†å¤œæ™¯.jpg";
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        updateLocationSelect();
        locationSelect.addEventListener('change', () => {
            updateMoviePoster();
            updateBuildingImage();
        });

        // Add 3D tilt effect to notebook
        document.addEventListener('DOMContentLoaded', function() {
            // Create particles
            createParticles();
            
            // ç¡®ä¿ç”ŸæˆæŒ‰é’®æ­£ç¡®ç»‘å®šäº‹ä»¶
            const generateBtn = document.getElementById('generateStoryBtn');
            if (generateBtn) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                generateBtn.removeEventListener('click', generateStory);
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                generateBtn.addEventListener('click', generateStory);
            }
        });
        
        function createParticles() {
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'particles';
            document.body.appendChild(particlesContainer);
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random position
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                // Random size
                const size = Math.random() * 3 + 1;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Random animation duration
                const duration = Math.random() * 10 + 10;
                particle.style.animationDuration = duration + 's';
                
                // Random delay
                const delay = Math.random() * 5;
                particle.style.animationDelay = delay + 's';
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // Add typing animation to story output
        function animateStoryOutput() {
            const paragraphs = storyOutput.querySelectorAll('p');
            
            paragraphs.forEach((p, index) => {
                p.style.opacity = '0';
                p.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    p.style.opacity = '1';
                    p.style.transform = 'translateY(0)';
                }, 100 * (index + 1));
            });
        }
        
        // ä¿å­˜æ•…äº‹ä¸ºå›¾ç‰‡çš„å‡½æ•°
        function saveStoryAsImage() {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥å¤åˆ¶æ•…äº‹å†…å®¹
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '-9999px';
            tempContainer.style.width = '800px'; // å›ºå®šå®½åº¦
            tempContainer.style.padding = '40px';
            tempContainer.style.backgroundColor = 'rgba(20, 20, 30, 0.9)';
            tempContainer.style.border = '1px solid rgba(100, 100, 255, 0.3)';
            tempContainer.style.borderRadius = '8px';
            tempContainer.style.boxShadow = '0 0 20px rgba(50, 50, 150, 0.4)';
            tempContainer.style.color = 'rgba(255, 255, 255, 1)';
            tempContainer.style.fontFamily = 'var(--quote-font)';
            
            // æ·»åŠ æ ‡é¢˜
            const titleDiv = document.createElement('div');
            titleDiv.style.textAlign = 'center';
            titleDiv.style.marginBottom = '30px';
            titleDiv.style.fontSize = '24px';
            titleDiv.style.fontWeight = 'bold';
            titleDiv.style.color = 'rgba(0, 255, 200, 0.9)';
            titleDiv.textContent = 'å±±åŸ - æ‰‹æœ­';
            tempContainer.appendChild(titleDiv);
            
            // æ·»åŠ æ•…äº‹ç±»å‹
            const genreDiv = document.createElement('div');
            genreDiv.style.textAlign = 'center';
            genreDiv.style.marginBottom = '20px';
            genreDiv.style.fontSize = '16px';
            genreDiv.style.fontStyle = 'italic';
            genreDiv.style.color = 'rgba(255, 255, 255, 0.8)';
            genreDiv.textContent = storyGenreDiv.textContent;
            tempContainer.appendChild(genreDiv);
            
            // å¤åˆ¶æ•…äº‹å†…å®¹
            const storyContent = storyOutput.cloneNode(true);
            tempContainer.appendChild(storyContent);
            
            // æ·»åŠ åˆ°æ–‡æ¡£ä¸­
            document.body.appendChild(tempContainer);
            
            // ä½¿ç”¨html2canvasåº“å°†å†…å®¹è½¬æ¢ä¸ºå›¾ç‰‡
            // å¦‚æœåº“ä¸å­˜åœ¨ï¼ŒåŠ¨æ€åŠ è½½
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = function() {
                    captureAndDownload(tempContainer);
                };
                document.head.appendChild(script);
            } else {
                captureAndDownload(tempContainer);
            }
        }
        
        function captureAndDownload(container) {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const saveButton = document.getElementById('saveAsImageBtn');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
            saveButton.disabled = true;
            
            // ä½¿ç”¨html2canvasæ•è·å†…å®¹
            html2canvas(container, {
                scale: 2, // æé«˜æ¸…æ™°åº¦
                useCORS: true,
                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                logging: false,
                onclone: function(clonedDoc) {
                    // ç¡®ä¿å…‹éš†çš„å…ƒç´ æ ·å¼æ­£ç¡®
                    const clonedContainer = clonedDoc.querySelector('div');
                    if (clonedContainer) {
                        clonedContainer.style.width = '800px';
                        clonedContainer.style.padding = '40px';
                    }
                }
            }).then(canvas => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `å±±åŸæ‰‹æœ­_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveButton.textContent = originalText;
                saveButton.disabled = false;
                
                // ç§»é™¤ä¸´æ—¶å®¹å™¨
                document.body.removeChild(container);
            }).catch(error => {
                console.error('Error generating image:', error);
                alert('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveButton.textContent = originalText;
                saveButton.disabled = false;
                
                // ç§»é™¤ä¸´æ—¶å®¹å™¨
                document.body.removeChild(container);
            });
        }
        
        // æ·»åŠ æ–‡å­—ç²’å­æ•ˆæœå‡½æ•°
        function createTextParticles(element, event) {
            const rect = element.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // åˆ›å»ºç²’å­å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let particlesContainer = element.querySelector('.particles-container');
            if (!particlesContainer) {
                particlesContainer = document.createElement('div');
                particlesContainer.className = 'particles-container';
                element.appendChild(particlesContainer);
            }
            
            // åˆ›å»ºå¤šä¸ªç²’å­
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'text-particle';
                
                // éšæœºå¤§å°
                const size = Math.random() * 4 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // éšæœºä½ç½®åç§»
                const offsetX = (Math.random() - 0.5) * 20;
                const offsetY = (Math.random() - 0.5) * 20;
                
                // è®¾ç½®ç²’å­ä½ç½®
                particle.style.left = `${x + offsetX}px`;
                particle.style.top = `${y + offsetY}px`;
                
                // éšæœºåŠ¨ç”»å»¶è¿Ÿ
                particle.style.animationDelay = `${Math.random() * 0.5}s`;
                
                // æ·»åŠ åˆ°å®¹å™¨
                particlesContainer.appendChild(particle);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤ç²’å­
                setTimeout(() => {
                    if (particle.parentNode === particlesContainer) {
                        particlesContainer.removeChild(particle);
                    }
                }, 2000);
            }
        }

        // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šè¾“å…¥äº‹ä»¶
            locationSelect.addEventListener('change', handleLocationChange);
            nameInput.addEventListener('input', handleInputChange);
            
            // ç»‘å®šç¿»é¡µæŒ‰é’®äº‹ä»¶
            arrowBtn.addEventListener('click', slidePage);
            
            // ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶
            const backArrow = document.querySelector('.back-page-arrow');
            if (backArrow) {
                backArrow.addEventListener('click', slideBack);
            }
            
            // ç»‘å®šç”Ÿæˆæ•…äº‹æŒ‰é’®äº‹ä»¶
            const generateBtn = document.getElementById('generateStoryBtn');
            if (generateBtn) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                generateBtn.removeEventListener('click', generateStory);
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                generateBtn.addEventListener('click', generateStory);
            }
            
            // ç»‘å®šä¿å­˜å›¾ç‰‡æŒ‰é’®äº‹ä»¶
            const saveAsImageBtn = document.getElementById('saveAsImageBtn');
            if (saveAsImageBtn) {
                saveAsImageBtn.addEventListener('click', saveStoryAsImage);
            }
        });
    </script>

</body>

</html>    